{% extends "base/layout.html" %}

{% block actions %}
<li>
    <a href="{{ url_for('despesas.listar') }}">
        <img class="img-actions" src="{{ url_for('static', filename='img/actions/voltar.png') }}">
    </a>
</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="container">
        <div class="col-md-12">
            <div class="col-md-12">
                <h1>Nova despesa</h1>
                <br>
            </div>
        </div>
        <div class="col-md-12 text-center" id="politica">
            <div class="col-md-12">
                <h4>Política de solicitação de despesas.</h4>
                <p><strong>Para valores menores que R$ 500,00:</strong> prazo de pagamento mínimo de 5 dias.</p>
                <p><strong>Para valores entre R$ 500,00 e R$ 5.000,00:</strong> prazo de pagamento mínimo de 15 dias.</p>
                <p><strong>Para valores maiores que R$ 5.000,00:</strong> prazo de pagamento mínimo de 30 dias.</p>
            </div>
        </div>
        <div class="col-md-12">
            <form action="" method="POST" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
                <div class="col-md-12">
                    <div class="col-md-6">
                        {{ form.empresa.label }}
                        {% for error in form.empresa.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                        {{ form.empresa(class_='form-control') }}
                    </div>
                    <div class="col-md-6">
                        {{ form.fornecedor.label }}
                        {% for error in form.fornecedor.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                        {{ form.fornecedor(class_='form-control') }}
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="col-md-4">
                        {{ form.centro_custo.label }}
                        {% for error in form.centro_custo.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                        {{ form.centro_custo(class_='form-control', placeholder='##.##.##.####', size=13) }}
                    </div>
                    <div class="col-md-4">
                        {{ form.data_pagamento.label }}
                        {% for error in form.data_pagamento.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                        {{ form.data_pagamento(class_='form-control', id='data_pagamento', placeholder='DD/MM/AAAA') }}
                    </div>
                    <div class="col-md-4">
                        {{ form.valor_total.label }}
                        {% for error in form.valor_total.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                        {{ form.valor_total(class_='form-control', id='valor_pgto', placeholder='0,00') }}
                    </div>
                </div>

                <div class="col-md-12">
                    <div class="col-md-3">
                        {{ form.departamento.label }}
                        {% for error in form.departamento.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                        {{ form.departamento(class_='form-control') }}
                    </div>
                    <div class="col-md-3" id="tipo">
                        {{ form.tipo_solicitacao.label }}
                        {% for error in form.tipo_solicitacao.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                        {{ form.tipo_solicitacao(class_='form-control') }}
                    </div>
                    <div class="col-md-3" id="forma_pagamento">
                        {{ form.forma_pagamento.label }}
                        {% for error in form.forma_pagamento.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                        {{ form.forma_pagamento(class_='form-control') }}
                    </div>
                    <div class="col-md-3" id="previsao">
                        {{ form.previsao.label }}
                        {% for error in form.previsao.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                        {{ form.previsao(class_='form-control') }}
                    </div>
                </div>

                <div class="col-md-12">
                    <div class="col-md-12">
                        {{ form.descricao.label }}
                        {% for error in form.descricao.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-12">
                        {{ form.descricao(class_='form-control', placeholder='Descreva aqui a despesa referente a esta solicitação.', cols=50, rows=5) }}
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="col-md-12">
                        {{ form.observacao.label }}
                        {% for error in form.observacao.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-12">
                        {{ form.observacao(class_='form-control', id='observacao', cols=50, rows=5) }}
                    </div>
                </div>
                <div class="col-md-12" id="documento">
                    <div class="col-md-12">
                        {{ form.boleto.label }}
                        {% for error in form.boleto.errors %}
                            <span class="error">[{{ error }}]</span>
                        {% endfor %}
                    </div>
                    <div class="col-md-12">
                        {{ form.boleto(class_='form-control') }}
                    </div>
                </div>
                <div class="col-md-12">
                    <div class="col-md-12">
                        <br>
                        {{ form.submit(class_='btn btn-lg btn-primary btn-block') }}
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">

    $("#politica").hide();

    var placeholder='Acrescente aqui quaisquer observações necessárias quanto a esta solicitação. '
    $("#observacao").attr('placeholder', placeholder);
    
    function parseDate(str) {
        var date_parts = str.split("/");
        return new Date(date_parts[2], date_parts[1] - 1, date_parts[0]);
    };
    
    function daysdiff(date1, date2) {
        return Math.floor(1 + ((date2 - date1) / (1000 * 60 * 60 * 24)));
        return (date2 - date1)
    };

    function toFloat(str) {
        return parseFloat(str.replace(",", "."))
    };

    $("#tipo").on("change", function(e){

        var forma_pgto = $("#forma_pagamento option:selected").val();
        var tipo = $("#tipo option:selected").val();

        if (tipo !== '50'){
            $("#previsao").show();
        } else {
            $("#previsao").hide();
        };

        if (forma_pgto === 'BOL' && tipo !== '50'){
            $("#documento").show();
        } else {
            $("#documento").hide();
        };

    });


    $("#forma_pagamento").on("change", function(e){

        var forma_pgto = $("#forma_pagamento option:selected").val();
        var tipo = $("#tipo option:selected").val();

        if (forma_pgto === 'BOL' && tipo !== '50'){
            $("#documento").show();
            placeholder='Acrescente aqui quaisquer observações necessárias quanto a esta solicitação. '
            $("#observacao").attr('placeholder', placeholder);
        } else if (forma_pgto === 'DEP' && tipo !== '50') {
            placeholder += 'Inclua os dados bancários para depósito. '
            $("#observacao").attr('placeholder', placeholder);
        } else {
            $("#documento").hide();
            placeholder='Acrescente aqui quaisquer observações necessárias quanto a esta solicitação. '
            $("#observacao").attr('placeholder', placeholder);
        };

    });

    $(".btn").on("click", function(e){

        var data_pgto = parseDate($("#data_pagamento").val());
        var datediff = daysdiff(Date.now(), data_pgto);
        var valor = toFloat($("#valor_pgto").val());
        var obs = $("#observacao").val();


        if (datediff <= 0) {
            alert("Data inválida.");
            return false;
        } else if (obs == "") {
            if (datediff == 1) {
                alert("Vencimento menor do que 2 dias.\nJustifique a urgência em 'Observação', ou altere a data.");
                $("#politica").show();
                placeholder += 'Justifique a necessidade de urgência deste pagamento.'
                $("#observacao").attr('placeholder', placeholder);
                return false;
            } else if (datediff < 5 && valor <= 500) {
                alert("Valores até R$ 500,00 devem ter vencimento igual ou maior do que 5 dias.\nJustifique a urgência em 'Observação' ou altere a data.");
                $("#politica").show();
                placeholder += 'Justifique a necessidade de urgência deste pagamento.'
                $("#observacao").attr('placeholder', placeholder);
                return false;
            } else if (datediff < 15 && valor > 500  && valor <= 5000) {
                alert("Valores entre R$ 500,00 e R$ 5000,00 devem ter vencimento igual ou maior do que 15 dias.\nJustifique a urgência em 'Observação' ou altere a data.");
                $("#politica").show();
                placeholder += 'Justifique a necessidade de urgência deste pagamento.'
                $("#observacao").attr('placeholder', placeholder);
                return false;
            } else if (datediff < 30 && valor > 5000) {
                alert("Valores acima de R$ 5000,00 devem ter vencimento igual ou maior do que 30 dias.\nJustifique a urgência em 'Observação' ou altere a data.");
                $("#politica").show();
                placeholder += 'Justifique a necessidade de urgência deste pagamento.'
                $("#observacao").attr('placeholder', placeholder);
                return false;
            };
        };
    });

</script>
{% endblock %}
